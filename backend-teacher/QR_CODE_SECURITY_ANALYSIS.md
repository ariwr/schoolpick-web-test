# QR 코드 시스템 보안 분석

## 📋 QR 코드 생성 로직

### 1. 토큰 생성 과정

```
1. 교사가 "3-1반 QR코드 생성" 버튼 클릭
   ↓
2. 프론트엔드: GET /api/attendance/qr/image/Y31?expires_in=1
   ↓
3. 백엔드: QRCodeService.generate_dynamic_token() 호출
   ↓
4. JWT 토큰 생성:
   {
     "exp": 1234567890,        // 만료 시간 (Unix timestamp)
     "iat": 1234567890,        // 발급 시간
     "room_id": "Y31",         // 반 정보 (3-1반)
     "type": "attendance_qr"   // 토큰 타입
   }
   ↓
5. SECRET_KEY로 서명 (HS256 알고리즘)
   ↓
6. QR 코드 이미지 생성 (토큰을 Base64 인코딩)
   ↓
7. 프론트엔드에 QR 코드 이미지 전송
```

### 2. 토큰 구조

```
JWT 토큰 = Header.Payload.Signature

Header:
{
  "alg": "HS256",
  "typ": "JWT"
}

Payload:
{
  "exp": 1234567890,        // 만료 시간
  "iat": 1234567890,        // 발급 시간
  "room_id": "Y31",         // 반 정보
  "type": "attendance_qr"   // 토큰 타입
}

Signature:
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  SECRET_KEY
)
```

### 3. QR 코드 갱신

- **자동 갱신**: 1분마다 새로운 토큰 생성
- **만료 시간**: 기본 1분 (설정 가능, 최대 60분)
- **목적**: 오래된 QR 코드로 재사용 방지

## 🔒 보안 검증 프로세스

### 학생 앱에서 QR 코드 스캔 시:

```
1. QR 코드 스캔 → 토큰 추출
   ↓
2. POST /api/attendance/qr/scan
   {
     "dynamic_token": "eyJ...",  // QR 코드에서 추출한 토큰
     "student_id": 123,
     "location_data": {
       "gps": { "latitude": 37.5665, "longitude": 126.978 },
       "wifi": { "bssids": ["aa:bb:cc:dd:ee:ff"] }
     },
     "device_id": "unique-device-id",
     "timestamp": "2025-11-05T20:30:00Z"
   }
   ↓
3. 백엔드 검증 프로세스:
   a) 토큰 검증 (JWT 서명 확인)
      - SECRET_KEY로 서명 검증
      - 만료 시간 확인
      - 토큰 타입 확인
   
   b) 위치 검증
      - GPS 좌표 확인 (허용 반경 내)
      - Wi-Fi BSSID 확인 (허용된 AP 목록)
   
   c) 기기 검증
      - device_id 제공 확인
      - 향후: 등록된 기기만 허용 가능
   
   d) 시간 검증
      - 출석 가능 시간 확인
      - 지각 여부 판단
   ↓
4. 검증 성공 → 출석 기록 생성
   검증 실패 → 부정행위 기록 생성
```

## ✅ 보안 강점

### 1. **JWT 서명 기반 보안**
- ✅ 토큰 위조 불가능 (SECRET_KEY로 서명)
- ✅ 토큰 내용 변조 감지 가능
- ✅ 서버에서만 토큰 생성 가능

### 2. **시간 기반 제한**
- ✅ 토큰 만료 시간 (1분)
- ✅ 1분마다 자동 갱신으로 재사용 방지
- ✅ 오래된 QR 코드 스캔 시 거부

### 3. **다중 검증 시스템**
- ✅ 토큰 검증
- ✅ 위치 검증 (GPS + Wi-Fi)
- ✅ 시간 검증
- ✅ 기기 검증

### 4. **부정행위 감지**
- ✅ 검증 실패 시 부정행위 기록
- ✅ 모든 스캔 데이터 저장 (감사 추적)

## ⚠️ 보안 취약점 및 개선 사항

### 1. **현재 취약점**

#### ⚠️ 토큰 재사용 가능성
- **문제**: 1분 이내에 같은 토큰을 여러 번 사용 가능
- **영향**: 한 학생이 여러 기기로 동시 스캔 가능
- **개선**: 토큰 사용 횟수 제한 또는 학생별 토큰 사용 기록

#### ⚠️ 위치 정보 위조 가능
- **문제**: 학생 앱에서 GPS/Wi-Fi 정보를 전송하므로 조작 가능
- **영향**: 원격에서 출석 가능
- **개선**: 서버 측 위치 검증 강화 또는 하드웨어 기반 검증

#### ⚠️ 기기 검증 미흡
- **문제**: device_id만 확인, 실제 기기 등록 없음
- **영향**: 여러 기기로 동일 학생 출석 가능
- **개선**: 기기 등록 시스템 구현

#### ⚠️ SECRET_KEY 노출 위험
- **문제**: SECRET_KEY가 환경변수에만 저장
- **영향**: 키 노출 시 모든 토큰 위조 가능
- **개선**: 키 순환 정책, 키 관리 시스템

### 2. **추가 보안 개선 제안**

#### 🔒 토큰 사용 횟수 제한
```python
# 각 토큰당 1회만 사용 가능하도록
token_usage_cache = {}  # 토큰별 사용 횟수 추적
```

#### 🔒 위치 검증 강화
- 서버 측 위치 검증 (추가 API 호출)
- 하드웨어 기반 위치 확인 (가능한 경우)

#### 🔒 기기 등록 시스템
- 학생별 등록된 기기만 허용
- 기기 변경 시 교사 승인 필요

#### 🔒 토큰 블랙리스트
- 만료된 토큰도 블랙리스트에 추가
- 재사용 시도 감지

## 📊 현재 보안 수준

### 보안 점수: ⭐⭐⭐⭐☆ (4/5)

**강점:**
- ✅ JWT 서명 기반 토큰 보안
- ✅ 다중 검증 시스템
- ✅ 시간 기반 제한
- ✅ 부정행위 감지

**개선 필요:**
- ⚠️ 토큰 재사용 방지
- ⚠️ 위치 정보 위조 방지
- ⚠️ 기기 등록 시스템

## 🔧 권장 개선 사항

1. **토큰 사용 횟수 제한**: 각 토큰당 1회만 사용
2. **기기 등록 시스템**: 학생별 등록된 기기만 허용
3. **위치 검증 강화**: 서버 측 추가 검증
4. **토큰 블랙리스트**: 만료된 토큰 추적
5. **SECRET_KEY 관리**: 키 순환 정책

